const i = require("inquirer");
const a = require("axios");
const c = require("chalk");
const f = require("fs");
const p = require("path");
const { JSDOM } = require("jsdom");
const crypto = require("crypto");

const name = "🧬 WebTech";
const description = "Fingerprint completo de tecnologías web y exposiciones públicas";

const run = async () => {
  const { x } = await i.prompt([{ type: "input", name: "x", message: "🌐 Dominio objetivo (sin https):" }]);
  const u = `https://${x}`;
  const j = { dominio: x, tecnologias: [], vulnerabilidades: [], detalles: {}, fecha: new Date().toISOString() };
  const l = [`🧬 Análisis de tecnologías de: ${x}`, `📅 ${j.fecha}`, ""];

  try {
    const r = await a.get(u, { timeout: 15000 });
    const h = r.headers;
    const b = r.data;
    const t = new Set();
    const v = [];

    j.detalles.headers = h;

    const headersTech = {
        server: (v) => t.add(v),
        "x-powered-by": (v) => t.add(v),
        "x-hosted-by": (v) => t.add(v),
        "x-amz-cf-id": () => t.add("AWS CloudFront"),
        "x-cdn": (v) => t.add(`CDN: ${v}`),
        "cf-ray": () => t.add("Cloudflare"),
        "x-sucuri-id": () => t.add("Sucuri"),
        "x-akamai-transformed": () => t.add("Akamai"),
        "x-hw": () => t.add("Edgecast CDN"),
        "x-instart-request-id": () => t.add("Instart Logic"),
        "x-fastly-request-id": () => t.add("Fastly CDN"),
        "x-vercel-id": () => t.add("Vercel"),
        "x-nextjs-cache": () => t.add("Next.js"),
        "x-cache": (v) => /hit/i.test(v) && t.add("Caching Enabled"),
        "x-drupal-cache": () => t.add("Drupal"),
        "x-generator": (v) => t.add(v),
        "x-umbraco-version": () => t.add("Umbraco CMS"),
        "x-magento-cache-debug": () => t.add("Magento"),
        "x-shopify-stage": () => t.add("Shopify"),
        "x-wix-request-id": () => t.add("Wix"),
        "x-prestashop": () => t.add("PrestaShop"),
        "x-cms": (v) => t.add(v),
        "x-served-by": (v) => t.add(`Hosted by: ${v}`),
        "x-powered-cms": (v) => t.add(v),
        "x-hostname": (v) => t.add(`Node: ${v}`),
        "x-dns-prefetch-control": () => t.add("DNS Prefetch"),
        "x-real-ip": () => v.push("❗ Header X-Real-IP expuesto (puede filtrar IP real del cliente)"),
        "via": (v) => t.add(`Proxy / CDN: ${v}`),
        "x-aspnet-version": (v) => t.add(`ASP.NET ${v}`),
        "x-powered-by-plesk": () => t.add("Plesk"),
        "x-mod-pagespeed": () => t.add("Google PageSpeed"),
        "x-opencart-version": (v) => t.add(`OpenCart ${v}`),
        "x-application-context": () => t.add("Spring Boot"),
        "x-backend-server": (v) => t.add(`Backend: ${v}`),
        "strict-transport-security": () => t.add("HSTS"),
        "content-security-policy": () => t.add("CSP (Content Security Policy)"),
        "x-content-type-options": () => t.add("Content-Type Options"),
        "x-frame-options": () => t.add("X-Frame-Options"),
        "x-xss-protection": () => t.add("X-XSS-Protection"),
        "referrer-policy": () => t.add("Referrer Policy"),
        "permissions-policy": () => t.add("Permissions Policy"),
        "expect-ct": () => t.add("Certificate Transparency (Expect-CT)"),
        "x-cache-status": (v) => t.add(`Cache: ${v}`),
        "x-google-cache-control": () => t.add("Google Cloud"),
        "x-gcp-project": () => t.add("Google Cloud Project"),
        "x-heroku-app-name": () => t.add("Heroku"),
        "x-render-id": () => t.add("Render.com"),
        "x-debug-token": () => v.push("⚠️ Debug token activo (potencial fuga de información)"),
        "x-dev-mode": () => v.push("⚠️ Sitio en modo desarrollador"),
        "x-env": (v) => v && v !== "production" && v.push(`⚠️ Entorno expuesto: ${v}`),
        "x-api-version": (v) => t.add(`API Version: ${v}`),
        "x-application-version": (v) => t.add(`App Version: ${v}`),
        "x-original-url": () => v.push("⚠️ X-Original-URL expuesto (posible fuga de paths internos)"),
        "x-rewrite-url": () => v.push("⚠️ Rewrite URL activo"),
        "x-forwarded-for": () => v.push("⚠️ X-Forwarded-For visible"),
        "x-azure-ref": () => t.add("Azure"),
        "x-bc-cacheid": () => t.add("BigCommerce"),
        "x-forwarded-host": () => t.add("Reverse Proxy activo"),
        "x-proxy-id": () => t.add("Proxy detectado"),
        "x-via": (v) => t.add(`Proxy: ${v}`),
        };

    Object.keys(headersTech).forEach(k => {
    if (h[k]) headersTech[k](h[k]);
    });

    if (!h["content-security-policy"]) v.push("❗ Falta Content-Security-Policy");
    if (!h["strict-transport-security"]) v.push("❗ Falta HSTS");
    if (h["x-powered-by"] && /php/i.test(h["x-powered-by"])) v.push("⚠️ PHP expuesto, revisar versión");

    const dom = new JSDOM(b);
    const doc = dom.window.document;

    const metas = [...doc.querySelectorAll("meta")];
    metas.forEach(m => {
      if (m.name?.toLowerCase() === "generator") t.add(m.content);
    });
    const scr = [...doc.querySelectorAll("script")].map(s => s.src || "").filter(Boolean);
    const jsMatches = [
        ["jQuery", /jquery/i],
        ["React", /react(-dom)?/i],
        ["Vue.js", /vue/i],
        ["Angular", /angular/i],
        ["Svelte", /svelte/i],
        ["Alpine.js", /alpine\.js/i],
        ["Backbone.js", /backbone/i],
        ["Ember.js", /ember/i],
        ["Preact", /preact/i],
        ["Inferno", /inferno/i],
        ["Next.js", /_next|next\.config/i],
        ["Nuxt.js", /_nuxt|nuxt\.config/i],
        ["Gatsby", /gatsby/i],
        ["Meteor", /meteor/i],
        ["Remix", /remix|build\/remix/i],
        ["Astro", /astro\.build/i],
        ["Bootstrap", /bootstrap/i],
        ["Tailwind CSS", /tailwind/i],
        ["Bulma", /bulma/i],
        ["Foundation", /foundation/i],
        ["Material UI", /material(\.|-ui)|mui/i],
        ["UIKit", /uikit/i],
        ["Ghost CMS", /ghost(-content|-scripts)?/i],
        ["Shopify", /cdn\.shopify\.com|cdn\.shopifycdn/i],
        ["Magento", /mage|magento/i],
        ["Wix", /wixstatic/i],
        ["Weebly", /weeblycloud/i],
        ["BigCommerce", /bigcommerce/i],
        ["Squarespace", /squarespace\.com/i],
        ["Contentful", /cdn\.contentful\.com/i],
        ["Sanity", /cdn\.sanity\.io/i],
        ["WordPress JS", /wp-(content|includes)/i],
        ["Google Analytics", /gtag|analytics\.js|ga\.js/i],
        ["Google Tag Manager", /googletagmanager\.com/i],
        ["Google Optimize", /optimize\.js/i],
        ["Yandex Metrica", /mc\.yandex\.ru/i],
        ["Matomo", /matomo/i],
        ["Plausible", /plausible\.io/i],
        ["Simple Analytics", /scripts\.simpleanalyticscdn\.com/i],
        ["Segment", /cdn\.segment\.com/i],
        ["Mixpanel", /mixpanel/i],
        ["Heap", /heapanalytics/i],
        ["Amplitude", /amplitude\.com/i],
        ["Crazy Egg", /crazyegg/i],
        ["Microsoft Clarity", /clarity\.ms/i],
        ["Quantcast", /quantserve\.com/i],
        ["Hotjar", /hotjar/i],
        ["Intercom", /intercom/i],
        ["LiveChat", /livechat|cdn\.livechatinc\.com/i],
        ["Zopim Live Chat", /zopim/i],
        ["Tawk.to", /tawk\.to/i],
        ["FreshChat", /freshchat/i],
        ["Optimizely", /optimizely/i],
        ["Unbounce", /d\.unbounce\.com/i],
        ["VWO", /visualwebsiteoptimizer/i],
        ["Sentry", /sentry\.io/i],
        ["Rollbar", /rollbar/i],
        ["Raygun", /raygun/i],
        ["LogRocket", /logrocket/i],
        ["Datadog RUM", /datadog.*rum/i],
        ["Cloudflare", /cloudflare-static/i],
        ["Fastly", /fastly\.net/i],
        ["jsDelivr", /cdn\.jsdelivr\.net/i],
        ["cdnjs", /cdnjs\.cloudflare\.com/i],
        ["UNPKG", /unpkg\.com/i],
        ["Stripe", /stripe\.js/i],
        ["PayPal", /paypal\.com|paypalobjects/i],
        ["Klarna", /klarna/i],
        ["Square", /squareup\.com/i],
        ["reCAPTCHA", /recaptcha/i],
        ["hCaptcha", /hcaptcha\.com/i],
        ["FontAwesome", /fontawesome/i],
        ["Typeform", /typeform/i],
        ["HubSpot", /hs-scripts|hubspot\.com/i],
        ["Calendly", /calendly/i],
        ["Snap Pixel", /snapads\.com/i],
        ["TikTok Pixel", /tiktok.*analytics/i],
        ["Facebook Pixel", /connect\.facebook\.net.*fbevents/i]
        ];
    jsMatches.forEach(([n, r]) => {
      if (scr.some(s => r.test(s))) t.add(n);
    });

    j.detalles.scripts = scr;

    const htmlSigns = [
        ["WordPress", /wp-content|wp-includes|xmlrpc\.php|wp-json/i],
        ["Drupal", /drupal/i],
        ["Joomla", /joomla/i],
        ["Magento", /mage|Magento/i],
        ["Ghost CMS", /ghost-content|ghost\.(js|json)/i],
        ["PrestaShop", /prestashop/i],
        ["OpenCart", /catalog\/view\/theme|opencart/i],
        ["Shopify", /cdn\.shopifycdn\.com|cdn\.shopify\.com/i],
        ["Blogger", /blogger/i],
        ["Wix", /wix\.com|wixsite/i],
        ["Weebly", /weeblycloud/i],
        ["Squarespace", /squarespace\.com/i],
        ["Strapi", /strapi/i],
        ["Umbraco", /umbraco/i],
        ["Contentful", /cdn\.contentful\.com/i],
        ["Sanity CMS", /cdn\.sanity\.io/i],
        ["OctoberCMS", /octobercms/i],
        ["Grav CMS", /grav/i],
        ["SilverStripe", /silverstripe/i],
        ["Laravel", /\/storage\/|\/vendor\/laravel|laravel\.mix/i],
        ["Symfony", /symfony/i],
        ["CodeIgniter", /codeigniter/i],
        ["Django", /csrfmiddlewaretoken|django/i],
        ["Flask", /flask/i],
        ["Express", /express/i],
        ["Ruby on Rails", /authenticity_token|rails/i],
        ["Spring Boot", /springframework/i],
        [".NET", /asp\-net|\.aspx/i],
        ["Struts", /struts/i],
        ["Phoenix (Elixir)", /phoenix/i],
        ["Zimbra", /zimbra/i],
        ["Roundcube", /roundcube/i],
        ["Horde", /horde/i],
        ["RainLoop", /rainloop/i],
        ["Admin Panel", /\/(admin|dashboard|administrator|admin-login|cpanel|manage|backend|system)/i],
        ["Dev Panel", /\/(staging|test|debug|dev|devtools)/i],
        ["Node-RED", /node-red/i],
        ["Grafana", /grafana/i],
        ["Kibana", /kibana/i],
        ["Prometheus", /prometheus/i],
        ["phpMyAdmin", /phpmyadmin/i],
        ["cPanel", /cpanel/i],
        ["Login Form", /type=["']?password["']?/i],
        ["Sign Up", /register|sign[\s_-]?up/i],
        ["Forgot Password", /forgot[\s_-]?password/i],
        ["Token Form", /csrf|_token|access_token/i],
        ["2FA", /2fa|otp|authenticator/i],
        ["CKEditor", /ckeditor/i],
        ["TinyMCE", /tinymce/i],
        ["Quill", /quill/i],
        ["Froala", /froala/i],
        ["Summernote", /summernote/i],
        ["Stripe", /stripe/i],
        ["PayPal", /paypal/i],
        ["Klarna", /klarna/i],
        ["WooCommerce", /woocommerce/i],
        ["Salesforce", /salesforce/i],
        ["HubSpot", /hubspot/i],
        ["Zoho", /zoho/i],
        ["Bitrix", /bitrix/i],
        ["Odoo", /odoo/i],
        ["reCAPTCHA", /recaptcha/i],
        ["hCaptcha", /hcaptcha/i],
        ["FingerprintJS", /fingerprintjs/i],
        ["HTML Comments", /<!--.*(TODO|DEBUG|DEV|PASSWORD|SECRET|KEY).*>/i],
        ["Internal IP", /\b10\.\d+\.\d+\.\d+|\b192\.168\.\d+\.\d+|\b172\.(1[6-9]|2\d|3[01])\.\d+\.\d+/],
        ["Error Stack", /Traceback|Exception|Stack trace/i],
        ["Debug Message", /"debug"|__debug__/i],
        ["Environment Leak", /NODE_ENV|APP_ENV|ENVIRONMENT/i],
        ["API Key Leak", /(AIza[0-9A-Za-z\-_]{35})|(sk_live_[0-9a-zA-Z]{24})|(pk_live_[0-9a-zA-Z]{24})/i],
        ["Swagger UI", /swagger-ui/i],
        ["Socket.io", /socket\.io/i],
        ["PWA", /manifest\.json/i],
        ["WebAssembly", /\.wasm/i],
        ["Base64 JS", /data:text\/javascript;base64,/i]
        ];

    htmlSigns.forEach(([n, r]) => {
      if (r.test(b)) t.add(n);
    });

    const exposures = [
        { name: ".env", path: "/.env" },
        { name: "Git Config", path: "/.git/config" },
        { name: "Git HEAD", path: "/.git/HEAD" },
        { name: "SVN Entries", path: "/.svn/entries" },
        { name: ".htaccess", path: "/.htaccess" },
        { name: "Apache Config", path: "/httpd.conf" },
        { name: "Nginx Config", path: "/nginx.conf" },
        { name: "Dockerfile", path: "/Dockerfile" },
        { name: "docker-compose.yml", path: "/docker-compose.yml" },
        { name: "Kubernetes config", path: "/.kube/config" },
        { name: "composer.json", path: "/composer.json" },
        { name: "package.json", path: "/package.json" },
        { name: "config.json", path: "/config.json" },
        { name: "settings.py", path: "/settings.py" },
        { name: "Backup ZIP", path: "/backup.zip" },
        { name: "Backup TAR", path: "/backup.tar.gz" },
        { name: "MySQL Dump", path: "/dump.sql" },
        { name: "DB Backup", path: "/database.sql" },
        { name: "Old WP Backup", path: "/wp-backup.zip" },
        { name: "Users CSV", path: "/users.csv" },
        { name: "Admins CSV", path: "/admin.csv" },
        { name: "Backup JSON", path: "/backup.json" },
        { name: "Backup OLD", path: "/backup.old" },
        { name: "PHPInfo", path: "/phpinfo.php" },
        { name: "XDebug Trace", path: "/xdebug.trace" },
        { name: "API Docs (Swagger)", path: "/swagger.json" },
        { name: "API Docs UI", path: "/swagger" },
        { name: "GraphQL Playground", path: "/graphql" },
        { name: "GraphiQL IDE", path: "/graphiql" },
        { name: "Dev Tools", path: "/devtools" },
        { name: "Environment Dump", path: "/env" },
        { name: "Admin Panel", path: "/admin" },
        { name: "CPanel", path: "/cpanel" },
        { name: "phpMyAdmin", path: "/phpmyadmin" },
        { name: "wp-login", path: "/wp-login.php" },
        { name: "WordPress Admin", path: "/wp-admin" },
        { name: "Laravel Debug", path: "/_debugbar" },
        { name: "Django Admin", path: "/admin/login/" },
        { name: "Node-RED Editor", path: "/red" },
        { name: "Grafana Login", path: "/login" },
        { name: "Shell Script", path: "/shell.php" },
        { name: "Error Log", path: "/error.log" },
        { name: "Access Log", path: "/access.log" },
        { name: "Nginx Log", path: "/nginx.log" },
        { name: "Apache Log", path: "/apache.log" },
        { name: "Debug Log", path: "/debug.log" },
        { name: "robots.txt", path: "/robots.txt" },
        { name: "Security.txt", path: "/.well-known/security.txt" },
        { name: "AWS S3 Bucket Config", path: "/s3cfg" },
        { name: "Firebase Config", path: "/firebase.json" },
        { name: "GCP Secret JSON", path: "/google-services.json" },
        { name: "Staging Site", path: "/staging" },
        { name: "Old Site", path: "/old" },
        { name: "Dev Site", path: "/dev" },
        { name: "Backup Folder", path: "/backup" },
        { name: "Uploads Folder", path: "/uploads" },
        { name: "Public Files", path: "/files" },
        { name: "Private Files", path: "/private" },
        { name: "License Key File", path: "/license.key" },
        { name: "SSL Private Key", path: "/ssl.key" },
        { name: "PEM File", path: "/cert.pem" },
        { name: "Shell Backup", path: "/.bash_history" },
        { name: "Env Backup", path: "/env.old" },
        ];

    for (const ex of exposures) {
      try {
        const resp = await a.get(`https://${x}${ex.path}`, { timeout: 5000 });
        if (resp.status === 200 && resp.data.length > 10) {
          v.push(`🕳️ ${ex.name} expuesto (${ex.path})`);
        }
      } catch {}
    }

    try {
      const favRes = await a.get(`https://${x}/favicon.ico`, { responseType: "arraybuffer" });
      const hash = crypto.createHash("md5").update(favRes.data).digest("hex");
      j.detalles.faviconHash = hash;
      l.push(`🧩 Favicon Hash (MD5): ${hash}`);
    } catch {
      l.push("🧩 Favicon no encontrado.");
    }

    const uniq = [...t];
    j.tecnologias = uniq;
    j.vulnerabilidades = v;

    l.push(`\n🔍 Tecnologías detectadas:\n${"-".repeat(60)}\n${uniq.length ? uniq.join("\n") : "Nada detectado"}`);
    if (v.length) {
      l.push(`\n⚠️ Posibles vulnerabilidades o exposiciones:\n${"-".repeat(60)}\n${v.join("\n")}`);
    }

    const out = p.join(__dirname, "..", "..", "informes", "webtech");
    if (!f.existsSync(out)) f.mkdirSync(out, { recursive: true });
    const fn = `${x.replace(/\W+/g, "_")}_webtech_${Date.now()}`;
    f.writeFileSync(p.join(out, fn + ".json"), JSON.stringify(j, null, 2));
    f.writeFileSync(p.join(out, fn + ".txt"), l.join("\n"));

    console.log(c.green("\n✅ Informe generado en carpeta 'informes/'\n"));
  } catch (e) {
    console.log(c.red("❌ Error al analizar el dominio. Puede estar offline o sin HTTPS."));
  }
};

module.exports = { name, description, run };
